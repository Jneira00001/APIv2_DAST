name: ZAP API Scan (Auto - Test Mode)

on:
  push:
    branches:
      - main

env:
  MY_TOKEN: 548afd6fab3bea9794a41b31da0e9404f733e222
  OPENAPI_URL: https://demo.defectdojo.org/api/v2/oa3/schema/?format=json

jobs:
  zap_api_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Preparar workspace
        run: |
          mkdir -p zap/wrk
          chmod -R 777 zap/wrk

      - name: Descargar OpenAPI
        run: |
          curl -s "$OPENAPI_URL" -o zap/wrk/openapi-full.json

      - name: Limitar OpenAPI a 10 endpoints
        run: |
          jq '
            .paths |= (to_entries | .[:10] | from_entries)
          ' zap/wrk/openapi-full.json > zap/wrk/openapi-test.json

      - name: Crear configuraci√≥n ZAP
        run: |
          cat <<EOF > zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${MY_TOKEN}

          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF

      - name: Ejecutar ZAP API Scan
        run: |
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/openapi-test.json \
            -f openapi \
            -r zap-report.html \
            -z -configfile /zap/wrk/zap_options.prop \
            > zap/wrk/zap.log 2>&1 || true

      - name: Subir artefactos (reporte + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-results
          path: |
            zap/wrk/zap-report.html
            zap/wrk/zap.log
            zap/wrk/openapi-test.json
