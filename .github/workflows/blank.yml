name: DefectDojo Scan (Prueba Rapida 10 URLs)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  MY_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  # URL original (la usaremos para descargar, pero no para escanear directo)
  SOURCE_URL: "https://demo.defectdojo.org/api/v2/oa3/schema/?format=json"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar CÃ³digo
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk

      # 1. CONFIGURACIÃ“N DE AUTH
      - name: Crear ConfiguraciÃ³n ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${MY_TOKEN}
          
          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # 2. TRUCO NUEVO: RECORTAR EL SWAGGER A SOLO 10 URLS
      - name: Generar Mini-Swagger (10 URLs)
        run: |
          echo "â¬‡ï¸ Descargando Swagger completo..."
          # Descargamos el JSON original usando el Token
          curl -s -H "Authorization: Token ${MY_TOKEN}" "$SOURCE_URL" > full_schema.json
          
          echo "âœ‚ï¸ Recortando a las primeras 10 rutas..."
          # Usamos jq para dejar solo las primeras 10 entradas en "paths"
          jq '.paths |= (to_entries | .[:10] | from_entries)' full_schema.json > ./zap/wrk/mini_schema.json
          
          echo "âœ… Archivo mini_schema.json creado con Ã©xito."

      # 3. EJECUTAR ESCANEO (CONTRA EL ARCHIVO MINI)
      - name: Ejecutar Escaneo ZAP
        run: |
          REPORT_NAME="reporte-rapido.html"
          
          echo "ðŸš€ Iniciando escaneo rÃ¡pido (Solo 10 URLs)..."
          
          # NOTA EL CAMBIO EN -t:
          # Ahora apuntamos al archivo local "mini_schema.json" en lugar de la URL web.
          # Como el archivo ya estÃ¡ en la carpeta ./zap/wrk (que Docker ve), solo ponemos el nombre.
          
          docker run --rm -u 0 \
              -v $(pwd)/zap/wrk:/zap/wrk:rw \
              zaproxy/zap-stable zap-api-scan.py \
              -t "mini_schema.json" \
              -f openapi \
              -r "$REPORT_NAME" \
              -z "-configfile /zap/wrk/zap_options.prop" \
              2>&1 | tee ./zap/wrk/zap_console.log

      - name: Subir Artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-Rapido
          path: ./zap/wrk/*
