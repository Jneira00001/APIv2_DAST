name: DefectDojo Scan (Fixed JSON Injection)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # Token fijo
  MY_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  
  # ‚ö†Ô∏è URL CORREGIDA: Usamos la estructura est√°ndar "raw" de GitHub (sin refs/heads)
  OPENAPI_URL: "https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/main/openapi.json"
  
  # El objetivo
  API_TARGET: "https://demo.defectdojo.org"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk

      # 1. Configurar Auth (Archivo .prop)
      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token ${MY_TOKEN}
          
          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # 2. DESCARGAR Y MODIFICAR EL JSON
      - name: Preparar Definici√≥n OpenAPI
        run: |
          echo "‚¨áÔ∏è Descargando JSON..."
          curl -sL "$OPENAPI_URL" -o ./zap/wrk/raw_schema.json
          
          # Validaci√≥n de seguridad: Verificar si bajamos un JSON real
          if ! grep -q "openapi" ./zap/wrk/raw_schema.json; then
             echo "‚ùå ERROR: El archivo descargado no es un OpenAPI v√°lido."
             echo "   Contenido (primeras 5 lineas):"
             head -n 5 ./zap/wrk/raw_schema.json
             exit 1
          fi

          echo "üîß Inyectando servidor 'demo.defectdojo.org' en el JSON..."
          
          # TRUCO DE MAGIA CON JQ:
          # Le agregamos el bloque "servers" al JSON para que ZAP no se pierda.
          jq --arg target "$API_TARGET" '.servers = [{"url": $target}]' ./zap/wrk/raw_schema.json > ./zap/wrk/ready.json
          
          chmod 777 ./zap/wrk/ready.json
          
          echo "üìù Verificando inyecci√≥n (debe aparecer 'servers'):"
          grep -A 3 "servers" ./zap/wrk/ready.json || echo "‚ö†Ô∏è No se pudo hacer grep, pero continuamos."

      # 3. EJECUTAR ESCANEO (Usando el archivo inyectado)
      - name: Ejecutar Escaneo ZAP
        run: |
          echo "üöÄ Iniciando escaneo..."
          
          # Usamos el archivo ./zap/wrk/ready.json que ya tiene el servidor correcto.
          # Mantenemos -S (Safe Mode) para evitar bloqueos del WAF en 500 URLs.
          
          docker run --rm -u 0 \
              -v $(pwd)/zap/wrk:/zap/wrk:rw \
              zaproxy/zap-stable zap-api-scan.py \
              -t /zap/wrk/ready.json \
              -f openapi \
              -r /zap/wrk/reporte-final.html \
              -z "-configfile /zap/wrk/zap_options.prop" \
              -S \
              2>&1 | tee ./zap/wrk/zap_console.log

      - name: Verificar Resultado
        run: |
          if [ -f "./zap/wrk/reporte-final.html" ]; then
             echo "‚úÖ ¬°√âXITO! Reporte generado."
          else
             echo "‚ùå Fallo: No hay reporte."
             exit 1
          fi

      - name: Subir Reporte
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-DefectDojo
          path: ./zap/wrk/reporte-final.html
