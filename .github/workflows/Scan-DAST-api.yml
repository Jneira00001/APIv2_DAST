name: DefectDojo Scan OpenAPI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  MY_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  SOURCE_URL: "https://demo.defectdojo.org/api/v2/oa3/schema/?format=json"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar CÃ³digo
        uses: actions/checkout@v4

      - name: Preparar directorios ZAP
        run: |
          mkdir -p ./zap/wrk
          chmod 755 ./zap/wrk

      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${MY_TOKEN}
          EOF

      - name: Descargar y Parchear JSON
        run: |
          # Descargar el esquema original
          curl -s -L \
            -H "Authorization: Token ${MY_TOKEN}" \
            "$SOURCE_URL" > ./zap/wrk/schema.json
          
          # Inyectar la URL base para que el script de ZAP no encuentre 0 URLs
          # Este cambio hace que el JSON pase de tener solo rutas a tener Host + Rutas
          sed -i 's/"openapi":"3.0.3",/"openapi":"3.0.3","servers":[{"url":"https:\/\/demo.defectdojo.org"}],/' ./zap/wrk/schema.json

      - name: Ejecutar Escaneo ZAP
        run: |
          TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            -e JAVA_OPTS="-Xmx5g" \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/schema.json \
            -f openapi \
            -r /zap/wrk/reporte-defectdojo-${TIMESTAMP}.html \
            -z "-configfile /zap/wrk/zap_options.prop -config openapi.importTimeoutInSecs=180"
