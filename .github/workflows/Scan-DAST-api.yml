name: ZAP API Scan (FIX FINAL)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  API_BASE_URL: "https://demo.defectdojo.org"
  API_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p zap/wrk zap/zaplog
          chmod -R 777 zap
          
      - name: Inyectar base URL en OpenAPI
        run: |
          jq --arg url "$API_BASE_URL" '
            .servers = [{ "url": $url }]
          ' openapi.json > zap/wrk/openapi.with-base.json
          
      - name: Crear configuración ZAP (Auth Header)
        run: |
          cat <<EOF > zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthorizationHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${API_TOKEN}
          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF
          
      - name: Ejecutar ZAP API Scan
        run: |
          docker run --rm -u 0 \
            -v $(pwd)/zap:/zap/wrk \
            -v $(pwd)/zap/zaplog:/home/zap/.ZAP \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/openapi.with-base.json \
            -f openapi \
            -r /zap/wrk/zap_api_report.html \
            -d \
            -z "
              -configfile /zap/wrk/zap_options.prop
              -config logger.level=DEBUG
              -config api.disablekey=true
            " \
            2>&1 | tee zap/wrk/zap_console.log
              
      - name: Verificar si existe el reporte
        if: always()
        run: |
          echo "Verificando archivos generados:"
          ls -la zap/wrk/
          if [ -f "zap/wrk/zap_api_report.html" ]; then
            echo "✓ Reporte HTML generado correctamente"
            echo "Tamaño del reporte: $(wc -c < zap/wrk/zap_api_report.html) bytes"
          else
            echo "✗ No se encontró el reporte HTML"
            echo "Contenido de zap/wrk/:"
            ls -la zap/wrk/
          fi
          
      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-results
          path: |
            zap/wrk/zap_api_report.html
            zap/wrk/zap_console.log
            zap/zaplog/zap.log
            zap/wrk/openapi.with-base.json
            zap/wrk/zap_options.prop
