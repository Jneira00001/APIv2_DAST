name: DAST API Scan DefectDojo

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_api_scan:
    runs-on: ubuntu-latest
    name: API Security Scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup y timestamp
        run: |
          echo "üïê [INICIO WORKFLOW] $(date '+%H:%M:%S')"
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
          mkdir -p ./zap/wrk
          echo "üìÅ Directorio creado: ./zap/wrk"
          echo "üåê URL Base: https://demo.defectdojo.org"
          echo "üìÑ OpenAPI URL: https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          
      - name: Verificar acceso a URLs
        run: |
          echo "üîç [VERIFICANDO URLs] $(date '+%H:%M:%S')"
          
          echo "1. Probando acceso a OpenAPI..."
          curl -s -I "https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json" | head -1 || echo "‚ö†Ô∏è  No se pudo acceder al OpenAPI"
          
          echo "2. Probando acceso a API base..."
          curl -s -I "https://demo.defectdojo.org/api/v2/announcements/" | head -1 || echo "‚ö†Ô∏è  No se pudo acceder a la API"
          
          echo "‚úÖ Verificaci√≥n completada"
        
      - name: Descargar imagen Docker
        run: |
          echo "‚¨áÔ∏è  [DESCARGANDO IMAGEN] Inicio: $(date '+%H:%M:%S')"
          echo "üîç Imagen: zaproxy/zap-weekly"
          
          # Mostrar tama√±o aproximado
          echo "üì¶ Tama√±o estimado: ~500MB"
          echo "‚è≥ Esto puede tomar varios minutos en la primera ejecuci√≥n..."
          
          # Descargar imagen con logs detallados
          docker pull zaproxy/zap-weekly 2>&1 | while read line; do
            if echo "$line" | grep -q "Downloading\|Download complete\|Pull complete\|Already exists"; then
              echo "   üì• $line"
            fi
          done
          
          echo "‚úÖ [IMAGEN DESCARGADA] Fin: $(date '+%H:%M:%S')"
          IMAGE_SIZE=$(docker images zaproxy/zap-weekly --format "{{.Size}}" 2>/dev/null || echo "No disponible")
          echo "üì¶ Tama√±o final: $IMAGE_SIZE"
        
      - name: Preparar autenticaci√≥n
        run: |
          echo "üîê [CONFIGURANDO AUTH] $(date '+%H:%M:%S')"
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          
          # Mostrar solo √∫ltimos 8 caracteres del token
          TOKEN_LENGTH=${#AUTH_TOKEN}
          if [ $TOKEN_LENGTH -gt 8 ]; then
            SHORT_TOKEN="********${AUTH_TOKEN: -8}"
          else
            SHORT_TOKEN="********"
          fi
          
          echo "   Token: $SHORT_TOKEN"
          echo "   URL Base: https://demo.defectdojo.org"
          echo "   OpenAPI: https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          
          # Crear archivo de configuraci√≥n completo
          cat > ./zap/wrk/scan_config.txt << EOF
          ========================================
          CONFIGURACI√ìN ZAP API SCAN
          ========================================
          FECHA: $(date)
          
          TARGETS:
          - API Base: https://demo.defectdojo.org
          - OpenAPI: https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json
          
          AUTHENTICACI√ìN:
          Token: $SHORT_TOKEN
          Header: Authorization: Token $AUTH_TOKEN
          
          OPCIONES ZAP:
          -f openapi
          -s (short output)
          -I (no fail on warning)
          
          REPORTS:
          Formato: HTML, JSON, XML, Markdown
          Prefijo: zap-api-report-${{ env.TIMESTAMP }}
          ========================================
          EOF
          
          echo "‚úÖ Archivo de configuraci√≥n creado"
        
      - name: Ejecutar ZAP API Scan
        run: |
          echo "üöÄ [INICIANDO SCAN] $(date '+%H:%M:%S')"
          echo "========================================"
          
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          REPORT="zap-api-report-${{ env.TIMESTAMP }}"
          OPENAPI_URL="https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          API_BASE="https://demo.defectdojo.org"
          
          echo "üéØ CONFIGURACI√ìN:"
          echo "   ‚Ä¢ Target OpenAPI: $OPENAPI_URL"
          echo "   ‚Ä¢ API Base: $API_BASE"
          echo "   ‚Ä¢ Reporte: $REPORT.*"
          
          # Construir opciones ZAP para autenticaci√≥n
          ZAP_OPTIONS="-config replacer.full_list\\(0\\).description=auth"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).enabled=true"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).matchtype=REQ_HEADER"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).matchstr=Authorization"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).regex=false"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).replacement=Token $AUTH_TOKEN"
          
          echo "üîß OPIONES ZAP:"
          echo "   $ZAP_OPTIONS"
          echo ""
          
          echo "‚ñ∂Ô∏è  EJECUTANDO COMANDO..."
          echo "docker run --rm -v \$(pwd)/zap/wrk:/zap/wrk:rw zaproxy/zap-weekly \\"
          echo "  python3 /zap/zap-api-scan.py \\"
          echo "  -t \"$OPENAPI_URL\" \\"
          echo "  -f openapi \\"
          echo "  -z \"$ZAP_OPTIONS\" \\"
          echo "  -O \"$API_BASE\" \\"
          echo "  -r \"$REPORT.html\" \\"
          echo "  -J \"$REPORT.json\" \\"
          echo "  -x \"$REPORT.xml\" \\"
          echo "  -w \"$REPORT.md\" \\"
          echo "  -s -I"
          echo ""
          
          echo "‚è≥ [SCAN EN PROGRESO] Inicio: $(date '+%H:%M:%S')"
          START_TIME=$(date +%s)
          
          # Ejecutar ZAP API Scan
          docker run --rm \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-weekly python3 /zap/zap-api-scan.py \
            -t "$OPENAPI_URL" \
            -f openapi \
            -z "$ZAP_OPTIONS" \
            -O "$API_BASE" \
            -r "$REPORT.html" \
            -J "$REPORT.json" \
            -x "$REPORT.xml" \
            -w "$REPORT.md" \
            -s -I 2>&1 | while read line; do
              CURRENT_TIME=$(date '+%H:%M:%S')
              echo "   [$CURRENT_TIME] $line"
            done
          
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo ""
          echo "‚úÖ [SCAN COMPLETADO] $(date '+%H:%M:%S')"
          echo "   C√≥digo de salida: $EXIT_CODE"
          echo "   Duraci√≥n total: ${DURATION}s"
          echo "   (~$((DURATION / 60))m $((DURATION % 60))s)"
          echo "========================================"
        
      - name: Analizar resultados
        run: |
          echo "üìä [ANALIZANDO RESULTADOS] $(date '+%H:%M:%S')"
          echo "========================================"
          
          REPORT="zap-api-report-${{ env.TIMESTAMP }}"
          REPORT_DIR="./zap/wrk"
          
          if [ ! -d "$REPORT_DIR" ]; then
            echo "‚ùå ERROR: Directorio $REPORT_DIR no existe"
            exit 1
          fi
          
          echo "üìÅ CONTENIDO DEL DIRECTORIO:"
          echo "----------------------------"
          ls -la "$REPORT_DIR/"
          echo "----------------------------"
          
          echo ""
          echo "üìÑ ESTADO DE REPORTES:"
          echo "----------------------------"
          
          TOTAL_FILES=0
          for ext in html json xml md; do
            FILE="$REPORT_DIR/$REPORT.$ext"
            if [ -f "$FILE" ]; then
              TOTAL_FILES=$((TOTAL_FILES + 1))
              SIZE=$(ls -lh "$FILE" | awk '{print $5}')
              LINES=$(wc -l < "$FILE" 2>/dev/null || echo "N/A")
              
              case $ext in
                "html")
                  echo "   üü¢ HTML: $REPORT.$ext"
                  echo "      üìè Tama√±o: $SIZE"
                  echo "      üìù L√≠neas: $LINES"
                  ;;
                "json")
                  echo "   üîµ JSON: $REPORT.$ext"
                  echo "      üìè Tama√±o: $SIZE"
                  echo "      üìù L√≠neas: $LINES"
                  
                  # Extraer estad√≠sticas si jq est√° disponible
                  if command -v jq >/dev/null 2>&1; then
                    ALERTS=$(jq '.alerts | length' "$FILE" 2>/dev/null || echo "0")
                    SITES=$(jq '.site | length' "$FILE" 2>/dev/null || echo "0")
                    echo "      ‚ö†Ô∏è  Alertas: $ALERTS"
                    echo "      üåê Sitios: $SITES"
                    
                    # Mostrar severidades si hay alertas
                    if [ "$ALERTS" -gt 0 ] && [ "$ALERTS" != "0" ]; then
                      echo "      üìä Severidades encontradas:"
                      jq -r '.alerts[] | .risk' "$FILE" 2>/dev/null | sort | uniq -c | while read count risk; do
                        echo "         ‚Ä¢ $risk: $count"
                      done || true
                    fi
                  fi
                  ;;
                "xml")
                  echo "   üü° XML: $REPORT.$ext"
                  echo "      üìè Tama√±o: $SIZE"
                  echo "      üìù L√≠neas: $LINES"
                  ;;
                "md")
                  echo "   üü£ Markdown: $REPORT.$ext"
                  echo "      üìè Tama√±o: $SIZE"
                  echo "      üìù L√≠neas: $LINES"
                  ;;
              esac
              echo ""
            else
              echo "   üî¥ $REPORT.$ext: NO GENERADO"
              echo ""
            fi
          done
          
          echo "----------------------------"
          echo "üìà RESUMEN:"
          echo "   Total de reportes generados: $TOTAL_FILES/4"
          
          if [ $TOTAL_FILES -eq 0 ]; then
            echo "   ‚ö†Ô∏è  ADVERTENCIA: No se generaron reportes"
          elif [ $TOTAL_FILES -lt 4 ]; then
            echo "   ‚ÑπÔ∏è  INFORMACI√ìN: Se generaron $TOTAL_FILES de 4 reportes esperados"
          else
            echo "   ‚úÖ √âXITO: Todos los reportes fueron generados"
          fi
          
          echo "========================================"
        
      - name: Subir reportes
        uses: actions/upload-artifact@v4
        with:
          name: api-scan-reports-${{ env.TIMESTAMP }}
          path: |
            ./zap/wrk/
          retention-days: 30
          if-no-files-found: error
        
      - name: Resumen final del workflow
        run: |
          echo ""
          echo "üèÅ [RESUMEN FINAL] $(date '+%H:%M:%S')"
          echo "========================================"
          echo "üìã INFORMACI√ìN DEL SCAN:"
          echo "   ‚Ä¢ Workflow: ${{ github.workflow }}"
          echo "   ‚Ä¢ Ejecuci√≥n: #${{ github.run_number }}"
          echo "   ‚Ä¢ Commit: ${GITHUB_SHA:0:8}"
          echo "   ‚Ä¢ Timestamp: ${{ env.TIMESTAMP }}"
          echo "   ‚Ä¢ Trigger: ${{ github.event_name }}"
          echo ""
          echo "üéØ CONFIGURACI√ìN USADA:"
          echo "   ‚Ä¢ OpenAPI: https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          echo "   ‚Ä¢ API Base: https://demo.defectdojo.org"
          echo "   ‚Ä¢ Imagen: zaproxy/zap-weekly"
          echo "   ‚Ä¢ Script: zap-api-scan.py"
          echo ""
          echo "üì• RESULTADOS:"
          echo "   ‚Ä¢ Artifact: api-scan-reports-${{ env.TIMESTAMP }}"
          echo "   ‚Ä¢ Contenido: Todos los reportes generados"
          echo "   ‚Ä¢ Retenci√≥n: 30 d√≠as"
          echo ""
          echo "üîç PR√ìXIMOS PASOS:"
          echo "   1. Ir a GitHub ‚Üí Actions ‚Üí Esta ejecuci√≥n"
          echo "   2. Descargar 'api-scan-reports-${{ env.TIMESTAMP }}'"
          echo "   3. Abrir 'zap-api-report-${{ env.TIMESTAMP }}.html'"
          echo "   4. Revisar vulnerabilidades encontradas"
          echo "   5. Para datos estructurados: usar el .json"
          echo ""
          echo "‚è±Ô∏è  DURACI√ìN TOTAL: $(($SECONDS / 60))m $(($SECONDS % 60))s"
          echo "========================================"
