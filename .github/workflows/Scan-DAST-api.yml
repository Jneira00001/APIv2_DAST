name: DAST Scan (Fix URL & Inject Server)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOJO_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  
  # ‚úÖ CORRECCI√ìN 1: URL RAW EST√ÅNDAR (Sin 'refs/heads')
  OPENAPI_URL: "https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/main/openapi.json"
  
  API_BASE: "https://demo.defectdojo.org"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preparar Entorno
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: üì• Descargar y Arreglar JSON
        run: |
          echo "‚¨áÔ∏è Descargando desde: $OPENAPI_URL"
          
          # Descargamos el archivo
          curl -sL "$OPENAPI_URL" -o ./zap/wrk/original.json
          
          # üïµÔ∏è DEBUG: Mostramos las primeras 10 l√≠neas para ver si es un 404
          echo "üìÑ Contenido descargado (Primeras l√≠neas):"
          head -n 10 ./zap/wrk/original.json
          
          # Validamos si es un JSON real
          if [[ $(head -n 1 ./zap/wrk/original.json) != *"openapi"* ]]; then
             echo "‚ùå ERROR: El archivo no parece un OpenAPI v√°lido (Posible 404)."
             exit 1
          fi

          echo "üîß Inyectando servidor base en el JSON..."
          # ‚úÖ CORRECCI√ìN 2: Usamos jq para agregar el bloque 'servers' manualmente.
          # Esto obliga a ZAP a entender d√≥nde est√° la API, sin depender del flag -O.
          jq --arg url "$API_BASE" '.servers = [{"url": $url}]' ./zap/wrk/original.json > ./zap/wrk/ready_to_scan.json
          
          chmod 777 ./zap/wrk/ready_to_scan.json
          echo "‚úÖ JSON parcheado y listo para escanear."

      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=auth
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token $DOJO_TOKEN
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      - name: Ejecutar ZAP
        run: |
          REPORT="zap-report-${{ env.TIMESTAMP }}"
          echo "‚ö° Iniciando ZAP..."

          # Usamos el archivo 'ready_to_scan.json' que ya tiene el servidor inyectado
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/ready_to_scan.json \
            -f openapi \
            -z "-configfile /zap/wrk/zap_options.prop" \
            -S \
            -r "$REPORT.html" \
            -J "$REPORT.json" \
            -l WARN \
            || echo "‚ö†Ô∏è ZAP termin√≥."

      - name: Verificar y Subir
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-Final-ZAP
          path: ./zap/wrk/
