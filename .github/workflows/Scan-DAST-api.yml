name: DAST Scan DefectDojo API

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_api_scan:
    runs-on: ubuntu-latest
    name: Scan DefectDojo API
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
        
      - name: Verificar OpenAPI
        run: |
          echo "üìä Verificando OpenAPI..."
          if [ -f "openapi.json" ]; then
            echo "‚úÖ openapi.json encontrado"
            jq -r '.info.title' openapi.json || echo "Sin t√≠tulo"
          else
            echo "‚ÑπÔ∏è  No hay openapi.json local, usando URL remota"
          fi
        
      - name: Create ZAP directory
        run: |
          mkdir -p ./zap/wrk
          sudo chmod -R 777 ./zap/wrk
        
      - name: Run ZAP API Scan
        run: |
          echo "üéØ INICIANDO ESCANEO DAST"
          echo "========================================"
          echo "üìÖ Fecha: ${{ env.TIMESTAMP }}"
          echo "üîó Trigger: ${{ github.event_name }}"
          
          # Configuraci√≥n
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          TARGET="https://demo.defectdojo.org"
          
          # Mostrar token abreviado
          TOKEN_LENGTH=${#AUTH_TOKEN}
          if [ $TOKEN_LENGTH -gt 8 ]; then
            SHORT_TOKEN="********${AUTH_TOKEN: -8}"
          else
            SHORT_TOKEN="********"
          fi
          echo "üîê Token: $SHORT_TOKEN"
          echo "üåê Target: $TARGET"
          
          # Usar ZAP Full Scan (que tambi√©n soporta APIs)
          docker run --rm \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-full-scan.py \
            -t "$TARGET/api/v2/" \
            -g gen.conf \
            -r "report-${{ env.TIMESTAMP }}.html" \
            -x "report-${{ env.TIMESTAMP }}.xml" \
            -J "report-${{ env.TIMESTAMP }}.json" || echo "ZAP completado"
          
          echo "========================================"
          echo "‚úÖ ESCANEO COMPLETADO"
          
          # Mostrar archivos
          echo "üìÑ ARCHIVOS GENERADOS:"
          ls -la ./zap/wrk/report-* 2>/dev/null || echo "No se encontraron reportes"
        
      - name: Probar endpoints manualmente
        run: |
          echo "üîç PROBANDO ENDPOINTS"
          echo "======================"
          
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          TARGET="https://demo.defectdojo.org"
          
          # Lista de endpoints a probar
          endpoints=(
            "/api/v2/announcements/"
            "/api/v2/products/"
            "/api/v2/engagements/"
            "/api/v2/findings/"
            "/api/v2/tests/"
          )
          
          for endpoint in "${endpoints[@]}"; do
            echo -n "üì° $endpoint ‚Üí "
            curl -s "$TARGET$endpoint" \
              -H "Authorization: Token $AUTH_TOKEN" \
              -o /tmp/response.json \
              -w "%{http_code}" \
              --max-time 10 || echo "ERROR"
            echo ""
            sleep 0.5
          done
          
          echo "======================"
          echo "‚úÖ Pruebas completadas"
        
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports-${{ env.TIMESTAMP }}
          path: |
            ./zap/wrk/report-${{ env.TIMESTAMP }}.*
            ./zap/wrk/gen.conf
          retention-days: 30
          if-no-files-found: warn
        
      - name: Mostrar resumen
        if: always()
        run: |
          echo ""
          echo "üìä RESUMEN DEL ESCANEO"
          echo "========================"
          echo "Estado: ${{ job.status }}"
          echo "Commit: ${GITHUB_SHA:0:8}"
          echo "Reportes: Disponibles en Artifacts"
          echo "Nombre: dast-reports-${{ env.TIMESTAMP }}"
          echo "========================"
