name: DAST Scan Simple
on: workflow_dispatch

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Iniciar ZAP
      run: |
        docker run -d --name zap -p 8080:8080 \
          owasp/zap2docker-stable:latest \
          zap.sh -daemon -host 0.0.0.0 -port 8080
        sleep 20
        
    - name: Escanear endpoints
      run: |
        echo "üîç Escaneando endpoints..."
        
        # Lista de endpoints principales
        endpoints=(
          "/api/v2/announcements/"
          "/api/v2/products/"
          "/api/v2/engagements/"
          "/api/v2/findings/"
          "/api/v2/tests/"
          "/api/v2/users/"
        )
        
        token="548afd6fab3bea9794a41b31da0e9404f733e222"
        target="https://demo.defectdojo.org"
        
        for endpoint in "${endpoints[@]}"; do
          echo "üì° Probando: $endpoint"
          curl -s -X GET "$target$endpoint" \
            -H "Authorization: Token $token" \
            --proxy http://localhost:8080 \
            -o /dev/null -w "  Status: %{http_code}\n"
          sleep 1
        done
        
    - name: Generar reporte
      run: |
        echo "üìÑ Generando reporte..."
        docker exec zap zap-cli --zap-url http://localhost:8080 report -o /zap/report.html -f html
        
        # Copiar reporte
        docker cp zap:/zap/report.html .
        
    - name: Subir reporte
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report.html
        
    - name: Limpiar
      run: docker rm -f zap
