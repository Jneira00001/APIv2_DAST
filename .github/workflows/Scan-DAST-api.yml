name: Debug Paths & Scan (Corregido)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  MY_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  SOURCE_URL: "https://demo.defectdojo.org/api/v2/oa3/schema/?format=json"

jobs:
  debug_and_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar C√≥digo
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk

      # 1. DESCARGAMOS EL ARCHIVO (Modo Camuflaje)
      - name: Descargar Swagger
        run: |
          echo "‚¨áÔ∏è Descargando archivo..."
          curl -s -L -A "Mozilla/5.0" \
            -H "Authorization: Token ${MY_TOKEN}" \
            "$SOURCE_URL" > ./zap/wrk/full_schema.json
          
          # Validaci√≥n b√°sica
          if [[ $(head -n 1 ./zap/wrk/full_schema.json) != *"{"* ]]; then
             echo "‚ùå Error: El archivo descargado no es un JSON v√°lido."
             head -n 5 ./zap/wrk/full_schema.json
             exit 1
          fi

          chmod 777 ./zap/wrk/full_schema.json
          echo "‚úÖ Archivo descargado correctamente."

      # 2. PRUEBA EN EL HOST (GITHUB RUNNER)
      - name: üïµÔ∏è Test 1 - Validar ruta en el Host
        run: |
          echo "üìÇ Listando carpeta local ./zap/wrk/ :"
          ls -la ./zap/wrk/

      # 3. PRUEBA DENTRO DE DOCKER (LA PRUEBA DE FUEGO)
      # Esta es la l√≠nea que te daba error. Ahora est√° corregida.
      - name: üïµÔ∏è Test 2 - Validar ruta DENTRO de Docker
        run: |
          echo "üê≥ Iniciando contenedor de prueba..."
          echo "Objetivo: Ver si /zap/wrk/full_schema.json existe dentro del contenedor."
          
          # Montamos el volumen y ejecutamos 'ls' dentro
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable \
            bash -c "ls -la /zap/wrk/ && echo '--- CHECK ---' && [ -f /zap/wrk/full_schema.json ] && echo '‚úÖ ARCHIVO ENCONTRADO' || echo '‚ùå ARCHIVO NO ENCONTRADO'"

      # 4. CONFIGURAR AUTH
      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${MY_TOKEN}
          
          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # 5. EJECUTAR ESCANEO REAL
      - name: Ejecutar Escaneo ZAP
        run: |
          echo "üöÄ Rutas validadas. Iniciando ZAP..."
          
          # NOTA IMPORTANTE DE RUTA:
          # Usamos /zap/wrk/full_schema.json (Ruta absoluta DENTRO del contenedor)
          # NO USAR ./zap/wrk/...
          
          docker run --rm -u 0 \
              -v $(pwd)/zap/wrk:/zap/wrk:rw \
              zaproxy/zap-stable zap-api-scan.py \
              -t /zap/wrk/full_schema.json \
              -f openapi \
              -r /zap/wrk/reporte-final.html \
              -O "https://demo.defectdojo.org" \
              -z "-configfile /zap/wrk/zap_options.prop" \
              -S \
              2>&1 | tee ./zap/wrk/zap_console.log

      - name: Subir Reporte
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-Validado
          path: ./zap/wrk/reporte-final.html
