name: DAST Scan (Validaci√≥n Final)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de DefectDojo'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      # 1. PRUEBA DE FUEGO: VERIFICAR TOKEN Y CONEXI√ìN
      # Esto te dir√° si el servidor te deja pasar o te est√° bloqueando
      - name: üß™ Verificar Conexi√≥n con Curl
        run: |
          TOKEN="${{ github.event.inputs.auth_token }}"
          echo "üì° Intentando conectar a DefectDojo desde GitHub Actions..."
          
          # Hacemos una petici√≥n simple a /api/v2/users/
          # Usamos -o /dev/null para no llenar la pantalla, solo queremos el c√≥digo HTTP
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Token $TOKEN" "https://demo.defectdojo.org/api/v2/users/")
          
          echo "üìù C√≥digo HTTP recibido: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "‚úÖ ¬°Conexi√≥n Exitosa! El Token funciona y la IP no est√° bloqueada."
          elif [ "$HTTP_STATUS" == "401" ] || [ "$HTTP_STATUS" == "403" ]; then
            echo "‚ùå ERROR: Acceso Denegado ($HTTP_STATUS)."
            echo "   Esto significa que el Token expir√≥ O que Cloudflare est√° bloqueando a GitHub."
            # No forzamos exit 1 para intentar que ZAP corra igual, pero ya est√°s avisado.
          else
            echo "‚ö†Ô∏è Respuesta inesperada: $HTTP_STATUS"
          fi

      # 2. CONFIGURAR AUTH ZAP
      - name: Configurar Auth ZAP
        run: |
          TOKEN="${{ github.event.inputs.auth_token }}"
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=auth
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token $TOKEN
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # 3. EJECUTAR ZAP (CON -S)
      - name: Ejecutar ZAP
        run: |
          # URL DE TU REPO
          OPENAPI_URL="https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          API_BASE="https://demo.defectdojo.org"
          REPORT="zap-report-${{ env.TIMESTAMP }}"

          echo "‚ö° Iniciando ZAP (Modo Safe)..."

          # NOTA IMPORTANTE:
          # He agregado -S (Safe Mode). Esto evitar√° el error "ScanNotStartedException".
          # Eliminar√° el ataque activo, pero generar√° el reporte de vulnerabilidades pasivas.
          
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t "$OPENAPI_URL" \
            -f openapi \
            -O "$API_BASE" \
            -z "-configfile /zap/wrk/zap_options.prop" \
            -S \
            -r "$REPORT.html" \
            -J "$REPORT.json" \
            -l WARN \
            || echo "‚ö†Ô∏è ZAP termin√≥."

      - name: Verificar Reporte
        run: |
          ls -la ./zap/wrk/
          if [ -f "./zap/wrk/zap-report-${{ env.TIMESTAMP }}.html" ]; then
             echo "‚úÖ REPORTE GENERADO."
          else
             echo "‚ùå Reporte fallido."
             exit 1
          fi

      - name: Subir Artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-Final
          path: ./zap/wrk/
