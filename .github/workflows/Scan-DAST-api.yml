name: ZAP API Scan (FIXED - HTML + Logs)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  API_BASE_URL: "https://demo.defectdojo.org"
  API_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p zap/wrk zap/zaplog
          chmod -R 777 zap

      # 1Ô∏è‚É£ Inyectar base URL
      - name: Inyectar base URL en OpenAPI
        run: |
          jq --arg url "$API_BASE_URL" '
            .servers = [{ "url": $url }]
          ' openapi.json > zap/wrk/openapi.with-base.json

          echo "‚úî OpenAPI listo:"
          ls -l zap/wrk

      # 2Ô∏è‚É£ Headers de autenticaci√≥n
      - name: Crear configuraci√≥n ZAP
        run: |
          cat <<EOF > zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthorizationHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${API_TOKEN}

          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF

      # 3Ô∏è‚É£ ZAP API Scan (RUTAS CORRECTAS)
      - name: Ejecutar ZAP API Scan
        run: |
          docker run --rm -u 0 \
            -v $(pwd)/zap:/zap/wrk \
            -v $(pwd)/zap/zaplog:/home/zap/.ZAP \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/wrk/openapi.with-base.json \
            -f openapi \
            -r /zap/wrk/wrk/zap_api_report.html \
            -d \
            --max-endpoints 10 \
            -z "
              -configfile /zap/wrk/wrk/zap_options.prop
              -config logger.level=DEBUG
              -config api.disablekey=true
            " \
            2>&1 | tee zap/wrk/zap_console.log

      # 4Ô∏è‚É£ Verificaci√≥n expl√≠cita
      - name: Verificar reporte
        run: |
          if [ -f "zap/wrk/zap_api_report.html" ]; then
            echo "‚úÖ Reporte HTML generado correctamente"
          else
            echo "‚ùå NO se gener√≥ el reporte HTML"
            echo "üìÑ Contenido de zap/wrk:"
            ls -l zap/wrk
          fi

      # 5Ô∏è‚É£ Artefactos
      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-results
          path: |
            zap/wrk/zap_api_report.html
            zap/wrk/zap_console.log
            zap/zaplog/zap.log
            zap/wrk/openapi.with-base.json
