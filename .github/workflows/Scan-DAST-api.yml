name: DAST Scan (Final - Token Fijo)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # 1. EL TOKEN PARA DEFECTDOJO (Necesario para escanear, NO para descargar el JSON)
  # Lo ponemos fijo aqu√≠ para asegurar que NUNCA llegue vac√≠o.
  DOJO_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  
  # 2. TU URL P√öBLICA (La que subiste a tu repo)
  # ZAP descargar√° esto libremente.
  OPENAPI_URL: "https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
  
  # 3. EL DESTINO
  API_BASE: "https://demo.defectdojo.org"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preparar Directorios
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      # PASO DE DIAGN√ìSTICO: Verificar que el Token NO est√© vac√≠o
      - name: üîç Verificar Variables
        run: |
          echo "1. URL del JSON: $OPENAPI_URL"
          echo "2. URL Base: $API_BASE"
          
          if [ -z "$DOJO_TOKEN" ]; then
            echo "‚ùå ERROR CR√çTICO: La variable DOJO_TOKEN est√° vac√≠a."
            exit 1
          else
            echo "‚úÖ Token cargado correctamente (Longitud: ${#DOJO_TOKEN} caracteres)."
          fi

      # PASO CR√çTICO: Configurar ZAP para usar el Token contra DefectDojo
      - name: Configurar Auth ZAP
        run: |
          # Creamos el archivo de configuraci√≥n.
          # Esto le dice a ZAP: "Cuando hables con la API, usa este header Authorization"
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=auth
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token $DOJO_TOKEN
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # EJECUTAR ZAP
      - name: Run ZAP API Scan
        run: |
          REPORT="zap-report-${{ env.TIMESTAMP }}"
          
          echo "‚ö° Iniciando ZAP (Modo Seguro -S)..."
          
          # EXPLICACI√ìN DE COMANDOS:
          # -t : Tu URL p√∫blica del JSON
          # -O : La URL de DefectDojo (Destino)
          # -z : Le pasa el archivo con el Token
          # -S : Modo Seguro (Evita que la demo te bloquee)
          
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t "$OPENAPI_URL" \
            -f openapi \
            -O "$API_BASE" \
            -z "-configfile /zap/wrk/zap_options.prop" \
            -S \
            -r "$REPORT.html" \
            -J "$REPORT.json" \
            -l WARN \
            || echo "‚ö†Ô∏è ZAP termin√≥ (Revisar reporte)."

      - name: Verificar Reporte
        run: |
          ls -lh ./zap/wrk/
          if [ -f "./zap/wrk/zap-report-${{ env.TIMESTAMP }}.html" ]; then
             echo "‚úÖ ¬°√âXITO! Reporte generado."
          else
             echo "‚ùå Reporte no encontrado. Algo fall√≥ en ZAP."
             exit 1
          fi

      - name: Subir Reporte
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-ZAP
          path: ./zap/wrk/
