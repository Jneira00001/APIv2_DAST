name: DAST Scan DefectDojo API

on:
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan DefectDojo API

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Create ZAP directory
        run: |
          mkdir -p ./zap/wrk
          sudo chmod -R 777 ./zap/wrk

      - name: Run ZAP Scan
        run: |
          echo "üéØ Iniciando escaneo DAST de DefectDojo API..."
          echo "üìÖ Fecha: ${{ env.TIMESTAMP }}"
          echo "üîê Token: ********${AUTH_TOKEN: -8}"
          
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          REPORT_NAME="report-${{ env.TIMESTAMP }}"
          
          # Ejecutar ZAP Baseline Scan
          docker run --rm \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            owasp/zap2docker-stable:latest \
            zap-baseline.py \
            -t "https://demo.defectdojo.org/api/v2/" \
            -H "Authorization: Token $AUTH_TOKEN" \
            -r "$REPORT_NAME.html" \
            -J "$REPORT_NAME.json" \
            -a
          
          echo "‚úÖ Escaneo completado"
          echo "üìÑ Reportes generados:"
          ls -la ./zap/wrk/*.html ./zap/wrk/*.json

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports-${{ env.TIMESTAMP }}
          path: ./zap/wrk/report-${{ env.TIMESTAMP }}.*
          retention-days: 30
