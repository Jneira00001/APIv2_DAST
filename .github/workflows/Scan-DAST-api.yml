name: ZAP API Scan Completo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  API_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  API_BASE_URL: "https://demo.defectdojo.org"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p ./zap/wrk ./zap/zaplog
          chmod -R 777 ./zap

      - name: Verificar archivo OpenAPI
        run: |
          echo "üîç Verificando archivo openapi.json..."
          if [ ! -f "openapi.json" ]; then
            echo "‚ùå ERROR: No se encontr√≥ openapi.json en el repositorio"
            echo "Archivos en el directorio ra√≠z:"
            ls -la
            exit 1
          fi
          
          # Validar que sea un JSON v√°lido
          if ! jq empty openapi.json 2>/dev/null; then
            echo "‚ùå ERROR: openapi.json no es un JSON v√°lido"
            exit 1
          fi
          
          echo "‚úÖ openapi.json encontrado y v√°lido"

      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${API_TOKEN}
          
          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          
          replacer.full_list(2).description=ContentTypeJson
          replacer.full_list(2).enabled=true
          replacer.full_list(2).matchtype=REQ_HEADER
          replacer.full_list(2).matchstr=Content-Type
          replacer.full_list(2).regex=false
          replacer.full_list(2).replacement=application/json
          EOF
          
          echo "‚úÖ Configuraci√≥n ZAP creada"

      - name: Preparar OpenAPI con URL base
        run: |
          echo "üîÑ Preparando archivo OpenAPI..."
          
          # Contar endpoints en el archivo original
          ENDPOINT_COUNT=$(jq '.paths | length' openapi.json)
          echo "üìä Endpoints encontrados en openapi.json: ${ENDPOINT_COUNT}"
          
          # Mostrar primeros endpoints como ejemplo
          echo "üìã Primeros 5 endpoints:"
          jq '.paths | keys[]' openapi.json | head -5
          
          # A√±adir servidor base si no existe
          echo "üåê Configurando servidor base: ${API_BASE_URL}"
          
          if jq '.servers' openapi.json | grep -q null; then
            # No existe servers, lo a√±adimos
            jq --arg url "${API_BASE_URL}" '. + {servers: [{url: $url}]}' openapi.json > ./zap/wrk/openapi_processed.json
            echo "‚ûï Servidor base a√±adido"
          else
            # Ya existe, lo reemplazamos
            jq --arg url "${API_BASE_URL}" '.servers = [{url: $url}]' openapi.json > ./zap/wrk/openapi_processed.json
            echo "üîÑ Servidor base actualizado"
          fi
          
          # Verificar que el procesamiento fue exitoso
          PROCESSED_COUNT=$(jq '.paths | length' ./zap/wrk/openapi_processed.json)
          
          if [ "$ENDPOINT_COUNT" != "$PROCESSED_COUNT" ]; then
            echo "‚ö†Ô∏è  Advertencia: Conteo de endpoints cambi√≥ de ${ENDPOINT_COUNT} a ${PROCESSED_COUNT}"
          fi
          
          echo "‚úÖ Archivo procesado:"
          echo "   - Tama√±o: $(wc -c < ./zap/wrk/openapi_processed.json) bytes"
          echo "   - Endpoints: ${PROCESSED_COUNT}"
          echo "   - Servidor: ${API_BASE_URL}"
          
          # Mostrar estructura del archivo procesado
          echo "üìù Estructura del archivo OpenAPI:"
          jq '{
            openapi: .openapi,
            info: .info,
            servers: .servers,
            paths_count: (.paths | length),
            components: (.components | keys)
          }' ./zap/wrk/openapi_processed.json

      - name: Limitar endpoints para prueba (Opcional)
        if: github.event_name == 'pull_request'
        run: |
          echo "‚ö° Limpiando para prueba r√°pida en PR..."
          jq '.paths |= (to_entries | .[:20] | from_entries)' ./zap/wrk/openapi_processed.json > ./zap/wrk/openapi_limited.json
          mv ./zap/wrk/openapi_limited.json ./zap/wrk/openapi_processed.json
          echo "‚úÖ Reducido a 20 endpoints para prueba r√°pida"

      - name: Ejecutar Escaneo ZAP
        timeout-minutes: 45
        run: |
          echo "üöÄ Iniciando escaneo completo de API..."
          echo "üîç URL Base: ${API_BASE_URL}"
          echo "üìÑ Archivo OpenAPI: openapi_processed.json"
          echo "üîÑ Tiempo m√°ximo: 45 minutos"
          
          # Crear un archivo de configuraci√≥n adicional
          cat <<EOF > ./zap/wrk/zap_additional.prop
          scanner.attackOnStart=true
          scanner.threadPerHost=3
          scanner.maxRuleDurationInMins=5
          scanner.delayInMs=200
          api.disablekey=true
          connection.timeoutInSecs=60
          EOF
          
          docker run --rm \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            -v $(pwd)/zap/zaplog:/home/zap/.ZAP:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/openapi_processed.json \
            -f openapi \
            -r /zap/wrk/zap_api_report.html \
            -x /zap/wrk/zap_report.xml \
            -J /zap/wrk/zap_report.json \
            -O "${API_BASE_URL}" \
            -d \
            -T 25 \
            -z "-configfile /zap/wrk/zap_options.prop \
                -configfile /zap/wrk/zap_additional.prop \
                -config scanner.maxAlertsPerRule=10" \
            2>&1 | tee ./zap/wrk/zap_console.log

      - name: Analizar resultados
        if: always()
        run: |
          echo "üìä ANALIZANDO RESULTADOS DEL ESCANEO"
          echo "====================================="
          
          # Verificar reportes generados
          REPORT_FILES=0
          if [ -f "./zap/wrk/zap_api_report.html" ]; then
            HTML_SIZE=$(wc -c < ./zap/wrk/zap_api_report.html)
            echo "‚úÖ Reporte HTML: ${HTML_SIZE} bytes"
            REPORT_FILES=$((REPORT_FILES + 1))
          else
            echo "‚ùå Reporte HTML no generado"
          fi
          
          if [ -f "./zap/wrk/zap_report.xml" ]; then
            XML_SIZE=$(wc -c < ./zap/wrk/zap_report.xml)
            echo "‚úÖ Reporte XML: ${XML_SIZE} bytes"
            REPORT_FILES=$((REPORT_FILES + 1))
          fi
          
          if [ -f "./zap/wrk/zap_report.json" ]; then
            JSON_SIZE=$(wc -c < ./zap/wrk/zap_report.json)
            echo "‚úÖ Reporte JSON: ${JSON_SIZE} bytes"
            REPORT_FILES=$((REPORT_FILES + 1))
          fi
          
          # Extraer estad√≠sticas del log
          echo ""
          echo "üìà ESTAD√çSTICAS DEL ESCANEO:"
          
          if [ -f "./zap/wrk/zap_console.log" ]; then
            # Contar diferentes tipos de mensajes
            ALERTS=$(grep -c "\[ALERT\]" ./zap/wrk/zap_console.log || echo "0")
            WARNINGS=$(grep -c "WARN\|WARNING" ./zap/wrk/zap_console.log || echo "0")
            ERRORS=$(grep -c "ERROR\|FAILED" ./zap/wrk/zap_console.log || echo "0")
            
            echo "   Alertas: ${ALERTS}"
            echo "   Advertencias: ${WARNINGS}"
            echo "   Errores: ${ERRORS}"
            
            # Encontrar el tiempo total del escaneo
            TIME_START=$(grep "Starting" ./zap/wrk/zap_console.log | head -1 | cut -d' ' -f2-4 || echo "Desconocido")
            TIME_END=$(grep "Shutting down" ./zap/wrk/zap_console.log | tail -1 | cut -d' ' -f2-4 || echo "Desconocido")
            
            echo "   Inicio: ${TIME_START}"
            echo "   Fin: ${TIME_END}"
            
            # Mostrar las √∫ltimas alertas encontradas
            echo ""
            echo "üö® √öLTIMAS ALERTAS ENCONTRADAS:"
            grep -A2 "\[ALERT\]" ./zap/wrk/zap_console.log | tail -10 || echo "   No se encontraron alertas recientes"
          fi
          
          # Verificar archivos en el directorio
          echo ""
          echo "üìÅ ARCHIVOS GENERADOS:"
          ls -lh ./zap/wrk/*.html ./zap/wrk/*.xml ./zap/wrk/*.json ./zap/wrk/*.log 2>/dev/null || echo "   No se encontraron archivos de reporte"

      - name: Crear reporte de resumen
        if: always()
        run: |
          echo "# üìã RESUMEN DEL ESCANEO ZAP API" > scan_summary.md
          echo "**Fecha:** $(date)" >> scan_summary.md
          echo "**URL Base:** ${API_BASE_URL}" >> scan_summary.md
          echo "" >> scan_summary.md
          
          echo "## üìä ESTAD√çSTICAS" >> scan_summary.md
          
          # Obtener conteo de endpoints
          if [ -f "./zap/wrk/openapi_processed.json" ]; then
            ENDPOINTS=$(jq '.paths | length' ./zap/wrk/openapi_processed.json)
            echo "- **Endpoints escaneados:** ${ENDPOINTS}" >> scan_summary.md
          fi
          
          # Estad√≠sticas de alertas desde XML si existe
          if [ -f "./zap/wrk/zap_report.xml" ]; then
            echo "" >> scan_summary.md
            echo "## üö® NIVELES DE ALERTA" >> scan_summary.md
            
            # Contar alertas por nivel (versi√≥n simplificada)
            HIGH=$(grep -c 'level="High"' ./zap/wrk/zap_report.xml 2>/dev/null || echo "0")
            MEDIUM=$(grep -c 'level="Medium"' ./zap/wrk/zap_report.xml 2>/dev/null || echo "0")
            LOW=$(grep -c 'level="Low"' ./zap/wrk/zap_report.xml 2>/dev/null || echo "0")
            INFO=$(grep -c 'level="Informational"' ./zap/wrk/zap_report.xml 2>/dev/null || echo "0")
            
            echo "| Nivel | Cantidad |" >> scan_summary.md
            echo "|-------|----------|" >> scan_summary.md
            echo "| üî¥ Alto | ${HIGH} |" >> scan_summary.md
            echo "| üü° Medio | ${MEDIUM} |" >> scan_summary.md
            echo "| üîµ Bajo | ${LOW} |" >> scan_summary.md
            echo "| ‚ÑπÔ∏è Informativo | ${INFO} |" >> scan_summary.md
            echo "" >> scan_summary.md
            echo "**Total de alertas:** $((HIGH + MEDIUM + LOW + INFO))" >> scan_summary.md
          fi
          
          echo "" >> scan_summary.md
          echo "## üìÅ ARCHIVOS DISPONIBLES" >> scan_summary.md
          
          FILES=""
          [ -f "./zap/wrk/zap_api_report.html" ] && FILES="${FILES}- \`zap_api_report.html\` - Reporte HTML interactivo\n"
          [ -f "./zap/wrk/zap_report.xml" ] && FILES="${FILES}- \`zap_report.xml\` - Reporte XML para integraci√≥n\n"
          [ -f "./zap/wrk/zap_report.json" ] && FILES="${FILES}- \`zap_report.json\` - Reporte JSON para procesamiento\n"
          [ -f "./zap/wrk/zap_console.log" ] && FILES="${FILES}- \`zap_console.log\` - Log completo de ejecuci√≥n\n"
          [ -f "./zap/wrk/openapi_processed.json" ] && FILES="${FILES}- \`openapi_processed.json\` - OpenAPI procesado\n"
          
          if [ -n "$FILES" ]; then
            echo -e "$FILES" >> scan_summary.md
          else
            echo "No se generaron archivos de reporte." >> scan_summary.md
          fi
          
          echo "" >> scan_summary.md
          echo "## ‚öôÔ∏è CONFIGURACI√ìN" >> scan_summary.md
          echo "- **Token:** \`${API_TOKEN:0:10}...\`" >> scan_summary.md
          echo "- **Tiempo m√°ximo:** 45 minutos" >> scan_summary.md
          echo "- **Modo:** Escaneo completo de API" >> scan_summary.md
          
          cat scan_summary.md

      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-scan-results
          path: |
            ./zap/
            scan_summary.md
          retention-days: 30
          
      - name: Notificar resultado
        if: always()
        run: |
          echo "üîî NOTIFICACI√ìN DE ESCANEO COMPLETADO"
          echo "======================================"
          
          if [ -f "./zap/wrk/zap_api_report.html" ]; then
            echo "‚úÖ Escaneo completado exitosamente"
            echo "üìä Reportes disponibles en la secci√≥n de artefactos"
          else
            echo "‚ö†Ô∏è  Escaneo completado con posibles problemas"
            echo "üìã Revisar logs para m√°s detalles"
          fi
