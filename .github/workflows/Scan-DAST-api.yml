name: DAST Scan (Python Loader)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # Token de DefectDojo (API Key)
  DOJO_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"
  
  # Tu URL del JSON en GitHub (Raw)
  OPENAPI_URL: "https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/main/openapi.json"
  
  # El Servidor Destino
  API_TARGET: "https://demo.defectdojo.org"

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preparar Directorios
        run: |
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      # 1. SCRIPT PYTHON: Descarga, Valida y Parchea el JSON
      # Este paso reemplaza a curl y jq para evitar errores de archivo vac√≠o.
      - name: üêç Descargar y Parchear JSON con Python
        shell: python
        env:
          URL_ORIGEN: ${{ env.OPENAPI_URL }}
          URL_DESTINO: ${{ env.API_TARGET }}
        run: |
          import os
          import json
          import urllib.request
          import sys

          print("‚¨áÔ∏è Iniciando descarga desde Python...")
          url = os.environ['URL_ORIGEN']
          target_server = os.environ['URL_DESTINO']
          file_path = "./zap/wrk/ready.json"

          try:
              # 1. Descargar
              with urllib.request.urlopen(url) as response:
                  if response.status != 200:
                      print(f"‚ùå Error HTTP: {response.status}")
                      sys.exit(1)
                  data = response.read()
                  
              # 2. Parsear JSON
              try:
                  json_content = json.loads(data)
              except json.JSONDecodeError as e:
                  print(f"‚ùå Error: Lo descargado NO es un JSON v√°lido.\n{e}")
                  print(f"Contenido parcial: {data[:100]}")
                  sys.exit(1)

              # 3. Validar contenido
              paths_count = len(json_content.get("paths", {}))
              print(f"‚úÖ JSON v√°lido. Rutas encontradas: {paths_count}")
              
              if paths_count == 0:
                  print("‚ö†Ô∏è ADVERTENCIA: El objeto 'paths' est√° vac√≠o. ZAP no encontrar√° nada.")

              # 4. Inyectar Servidor (El truco m√°gico)
              print(f"üîß Inyectando servidor: {target_server}")
              json_content["servers"] = [{"url": target_server}]

              # 5. Guardar archivo final
              with open(file_path, 'w') as f:
                  json.dump(json_content, f, indent=2)
              
              print(f"‚úÖ Archivo guardado correctamente en: {file_path}")

          except Exception as e:
              print(f"‚ùå Error fatal en el script: {e}")
              sys.exit(1)

      # 2. Configurar Auth ZAP
      - name: Configurar Auth ZAP
        run: |
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=auth
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token $DOJO_TOKEN
          EOF
          chmod 777 ./zap/wrk/zap_options.prop

      # 3. EJECUTAR ZAP
      - name: Ejecutar Escaneo ZAP
        run: |
          echo "üöÄ Iniciando escaneo ZAP..."
          
          # NOTA: 
          # - Quitamos el flag -O porque Python ya inyect√≥ la URL en el archivo.
          # - Usamos -S (Safe Mode) para que no tarde 20 horas.
          
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/ready.json \
            -f openapi \
            -z "-configfile /zap/wrk/zap_options.prop" \
            -S \
            -r /zap/wrk/reporte-final.html \
            -J /zap/wrk/reporte-final.json \
            -l WARN \
            || echo "‚ö†Ô∏è ZAP termin√≥ (verifica reporte)."

      - name: Verificar y Subir
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Reporte-DefectDojo
          path: ./zap/wrk/
