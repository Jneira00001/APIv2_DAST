name: DAST API Security Scan - DefectDojo Demoo

on:
  workflow_dispatch:  # Solo ejecuci√≥n manual
    inputs:
      target_url:
        description: 'URL target para escanear'
        required: true
        default: 'https://demo.defectdojo.org'
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap-full-api-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Preparar entorno y mostrar informaci√≥n
      run: |
        echo "=============================================="
        echo "üöÄ INICIANDO ESCANEO DAST COMPLETO"
        echo "=============================================="
        echo "Target: ${{ github.event.inputs.target_url }}"
        echo "Total de endpoints a analizar: TODOS (93 endpoints)"
        echo "Token Auth: ********${AUTH_TOKEN: -8}"
        echo "=============================================="
        
        # Mostrar estructura b√°sica del OpenAPI
        echo "üìä ANALIZANDO OPENAPI.JSON..."
        TOTAL_PATHS=$(jq '.paths | length' openapi.json)
        echo "Total de paths en OpenAPI: $TOTAL_PATHS"
        
        echo "üìã LISTA COMPLETA DE ENDPOINTS:"
        jq -r '.paths | keys[]' openapi.json | sort | while read endpoint; do
          METHODS=$(jq -r ".paths[\"$endpoint\"] | keys[]" openapi.json 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
          echo "  ‚Ä¢ $endpoint [$METHODS]"
        done
      env:
        AUTH_TOKEN: ${{ github.event.inputs.auth_token }}
        
    - name: Iniciar ZAP en modo daemon
      run: |
        echo "üîß INICIANDO OWASP ZAP..."
        docker run -d \
          --name zap \
          -u zap \
          -p 8080:8080 \
          -p 8090:8090 \
          -v $(pwd):/zap/wrk \
          -i owasp/zap2docker-stable:latest \
          zap.sh -daemon \
          -host 0.0.0.0 \
          -port 8080 \
          -config api.addrs.addr.name=.* \
          -config api.addrs.addr.regex=true \
          -config api.key=zap-api-key-123 \
          -config api.disablekey=true
        
        echo "‚è≥ Esperando que ZAP inicie..."
        sleep 15
        
        # Verificar que ZAP est√© funcionando
        until curl -s http://localhost:8080 > /dev/null; do
          echo "‚è≥ Esperando ZAP..."
          sleep 5
        done
        echo "‚úÖ ZAP listo en http://localhost:8080"
        
    - name: Configurar autenticaci√≥n en ZAP
      run: |
        echo "üîê CONFIGURANDO AUTENTICACI√ìN..."
        ZAP_URL="http://localhost:8080"
        API_KEY="zap-api-key-123"
        TARGET_URL="${{ github.event.inputs.target_url }}"
        AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
        
        # Crear script de autenticaci√≥n
        cat > auth_script.js << 'EOF'
        var HttpSender = Java.type('org.parosproxy.paros.network.HttpSender')
        var HttpRequestHeader = Java.type('org.parosproxy.paros.network.HttpRequestHeader')
        var HttpHeader = Java.type('org.parosproxy.paros.network.HttpHeader')
        var URI = Java.type('org.apache.commons.httpclient.URI')
        
        function sendingRequest(msg, initiator, helper) {
          var header = msg.getRequestHeader()
          var uri = header.getURI().toString()
          
          // Solo agregar token a requests del target
          if (uri.contains("$TARGET_URL")) {
            header.setHeader("Authorization", "Token $AUTH_TOKEN")
            header.setHeader("Content-Type", "application/json")
            header.setHeader("User-Agent", "ZAP-DAST-Scanner/1.0")
          }
        }
        
        function responseReceived(msg, initiator, helper) {
          // Log de respuestas
          print("Response: " + msg.getRequestHeader().getURI() + " - Status: " + msg.getResponseHeader().getStatusCode())
        }
        EOF
        
        # Reemplazar variables en el script
        sed -i "s|\$TARGET_URL|$TARGET_URL|g" auth_script.js
        sed -i "s|\$AUTH_TOKEN|$AUTH_TOKEN|g" auth_script.js
        
        # Cargar script en ZAP
        curl -s "$ZAP_URL/JSON/script/action/load/" \
          -d "scriptName=auth.js" \
          -d "scriptType=proxy" \
          -d "scriptEngine=Oracle Nashorn" \
          -d "fileName=/zap/wrk/auth_script.js" \
          -d "apikey=$API_KEY"
          
        echo "‚úÖ Autenticaci√≥n configurada"
        
    - name: Importar OpenAPI a ZAP
      run: |
        echo "üì• IMPORTANDO OPENAPI A ZAP..."
        ZAP_URL="http://localhost:8080"
        API_KEY="zap-api-key-123"
        TARGET_URL="${{ github.event.inputs.target_url }}"
        
        # Importar desde archivo local
        curl -s "$ZAP_URL/JSON/openapi/action/importFile/" \
          -F "file=@openapi.json" \
          -H "X-ZAP-API-Key: $API_KEY"
          
        # Tambi√©n importar desde URL
        curl -s "$ZAP_URL/JSON/openapi/action/importUrl/" \
          -d "url=$TARGET_URL/openapi.json" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -H "X-ZAP-API-Key: $API_KEY"
          
        echo "‚úÖ OpenAPI importado"
        
    - name: Ejecutar escaneo completo mostrando progreso
      run: |
        echo "üîç INICIANDO ESCANEO COMPLETO..."
        echo "=============================================="
        
        # Contador de endpoints
        ENDPOINT_COUNT=0
        
        # Escanear cada endpoint individualmente mostrando progreso
        jq -r '.paths | keys[]' openapi.json | while read endpoint; do
          ENDPOINT_COUNT=$((ENDPOINT_COUNT + 1))
          FULL_URL="${{ github.event.inputs.target_url }}$endpoint"
          
          echo ""
          echo "üìä [${ENDPOINT_COUNT}/93] ESCANEANDO: $endpoint"
          echo "   URL: $FULL_URL"
          
          # Obtener m√©todos para este endpoint
          METHODS=$(jq -r ".paths[\"$endpoint\"] | keys[]" openapi.json 2>/dev/null | tr '\n' ' ')
          
          for method in $METHODS; do
            echo "   M√©todo: $method"
            
            # Ejecutar request para que ZAP lo vea
            case $method in
              "get")
                curl -s -X GET "$FULL_URL" \
                  -H "Authorization: Token ${{ github.event.inputs.auth_token }}" \
                  -H "Content-Type: application/json" \
                  --proxy http://localhost:8080 \
                  -w "   Status: %{http_code}\n" \
                  -o /dev/null || true
                ;;
              "post")
                # Enviar body b√°sico para POST
                curl -s -X POST "$FULL_URL" \
                  -H "Authorization: Token ${{ github.event.inputs.auth_token }}" \
                  -H "Content-Type: application/json" \
                  -d '{"test": "dast_scan"}' \
                  --proxy http://localhost:8080 \
                  -w "   Status: %{http_code}\n" \
                  -o /dev/null || true
                ;;
              "put"|"patch")
                curl -s -X $method "$FULL_URL" \
                  -H "Authorization: Token ${{ github.event.inputs.auth_token }}" \
                  -H "Content-Type: application/json" \
                  -d '{"test": "dast_scan_update"}' \
                  --proxy http://localhost:8080 \
                  -w "   Status: %{http_code}\n" \
                  -o /dev/null || true
                ;;
              "delete")
                curl -s -X DELETE "$FULL_URL" \
                  -H "Authorization: Token ${{ github.event.inputs.auth_token }}" \
                  -H "Content-Type: application/json" \
                  --proxy http://localhost:8080 \
                  -w "   Status: %{http_code}\n" \
                  -o /dev/null || true
                ;;
            esac
            
            sleep 1  # Rate limiting b√°sico
          done
        done
        
        echo ""
        echo "=============================================="
        echo "‚úÖ ESCANEO PASIVO COMPLETADO"
        echo "   Total endpoints procesados: $ENDPOINT_COUNT"
        echo "=============================================="
        
    - name: Ejecutar Active Scan completo
      run: |
        echo "‚ö° INICIANDO ACTIVE SCAN (esto tomar√° varios minutos)..."
        echo "=============================================="
        
        TARGET_URL="${{ github.event.inputs.target_url }}"
        
        # Ejecutar active scan en ZAP
        SCAN_ID=$(curl -s "http://localhost:8080/JSON/ascan/action/scan/" \
          -d "url=$TARGET_URL" \
          -d "recurse=true" \
          -d "inScopeOnly=true" \
          -d "scanPolicyName=Default Policy" \
          -d "method=DELETE" \
          -d "postData=" \
          -H "X-ZAP-API-Key: zap-api-key-123" | jq -r '.scan')
        
        echo "Scan ID: $SCAN_ID"
        
        # Monitorear progreso
        while true; do
          STATUS=$(curl -s "http://localhost:8080/JSON/ascan/view/status/?scanId=$SCAN_ID" \
            -H "X-ZAP-API-Key: zap-api-key-123" | jq -r '.status')
          
          PERCENT=$(curl -s "http://localhost:8080/JSON/ascan/view/status/?scanId=$SCAN_ID" \
            -H "X-ZAP-API-Key: zap-api-key-123" | jq -r '.status')
          
          echo "Progreso Active Scan: $PERCENT%"
          
          if [[ "$PERCENT" == "100" ]]; then
            break
          fi
          
          sleep 10
        done
        
        echo "‚úÖ ACTIVE SCAN COMPLETADO"
        
    - name: Generar reportes
      run: |
        echo "üìÑ GENERANDO REPORTES..."
        
        # Generar reporte HTML
        curl -s "http://localhost:8080/OTHER/core/other/htmlreport/" \
          -H "X-ZAP-API-Key: zap-api-key-123" \
          -o zap-report.html
          
        echo "‚úÖ Reporte HTML generado: $(wc -l zap-report.html | awk '{print $1}') l√≠neas"
        
        # Generar reporte JSON
        curl -s "http://localhost:8080/JSON/core/view/alerts/" \
          -H "X-ZAP-API-Key: zap-api-key-123" \
          -o zap-report.json
          
        echo "‚úÖ Reporte JSON generado: $(jq '.alerts | length' zap-report.json) alertas"
        
        # Generar reporte XML (para otras herramientas)
        curl -s "http://localhost:8080/OTHER/core/other/xmlreport/" \
          -H "X-ZAP-API-Key: zap-api-key-123" \
          -o zap-report.xml
          
        echo "‚úÖ Reporte XML generado"
        
        # Generar resumen ejecutivo
        cat > scan-summary.txt << EOF
        ==============================================
        RESUMEN DE ESCANEO DAST - DEFECTDOJO API
        ==============================================
        Fecha: $(date)
        Target: ${{ github.event.inputs.target_url }}
        Total Endpoints: 93
        Token usado: ********${AUTH_TOKEN: -8}
        
        ESTAD√çSTICAS DE ALERTAS:
        $(jq -r '
          "Alertas por severidad:",
          "  High: " + (.alerts[] | select(.risk == "High") | .risk | length // 0),
          "  Medium: " + (.alerts[] | select(.risk == "Medium") | .risk | length // 0),
          "  Low: " + (.alerts[] | select(.risk == "Low") | .risk | length // 0),
          "  Informational: " + (.alerts[] | select(.risk == "Informational") | .risk | length // 0),
          "",
          "Top 5 alertas m√°s comunes:",
          (.alerts | group_by(.alert) | map({alert: .[0].alert, count: length}) | sort_by(-.count) | .[0:5] | .[] | "  " + .alert + ": " + (.count|tostring))
        ' zap-report.json 2>/dev/null || echo "  No se pudieron procesar las alertas")
        
        RECOMENDACIONES:
        1. Revisar reporte HTML para detalles completos
        2. Validar falsos positivos manualmente
        3. Considerar escaneos regulares programados
        4. Implementar WAF para protecci√≥n en producci√≥n
        
        ARCHIVOS GENERADOS:
        - zap-report.html (Reporte visual completo)
        - zap-report.json (Datos estructurados)
        - zap-report.xml (Compatibilidad con otras herramientas)
        - scan-summary.txt (Este resumen)
        ==============================================
        EOF
        
        echo "‚úÖ Resumen ejecutivo generado"
        
    - name: Detener ZAP y limpiar
      run: |
        echo "üßπ LIMPIANDO RECURSOS..."
        docker stop zap || true
        docker rm zap || true
        echo "‚úÖ Limpieza completada"
        
    - name: Subir reportes como artifacts
      uses: actions/upload-artifact@v3
      with:
        name: zap-dast-reports
        path: |
          zap-report.html
          zap-report.json
          zap-report.xml
          scan-summary.txt
        retention-days: 30
        
    - name: Mostrar resumen final
      run: |
        echo ""
        echo "=============================================="
        echo "üéâ ESCANEO DAST COMPLETADO EXITOSAMENTE"
        echo "=============================================="
        echo ""
        echo "üìä RESULTADOS:"
        echo ""
        cat scan-summary.txt
        echo ""
        echo "üì• REPORTES DESCARGABLES:"
        echo "  ‚Ä¢ zap-report.html - Reporte visual completo"
        echo "  ‚Ä¢ zap-report.json - Datos estructurados para an√°lisis"
        echo "  ‚Ä¢ zap-report.xml - Compatible con otras herramientas"
        echo "  ‚Ä¢ scan-summary.txt - Resumen ejecutivo"
        echo ""
        echo "üìç Los reportes est√°n disponibles en la secci√≥n 'Artifacts'"
        echo "   de esta ejecuci√≥n de GitHub Actions."
        echo ""
        echo "‚ö†Ô∏è  ADVERTENCIA: Este fue un escaneo REAL en ambiente DEMO compartido."
        echo "   Se realizaron requests GET, POST, PUT, PATCH y DELETE."
        echo "   Verificar que no se hayan afectado datos cr√≠ticos."
        echo "=============================================="
