name: DAST API Scan (Corregido )

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        run: |
          echo "üöÄ [START] Setup inicial"
          # Guardamos fecha para nombres √∫nicos
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV
          mkdir -p ./zap/wrk
          chmod 777 ./zap/wrk
          echo "‚úÖ Directorio creado: ./zap/wrk"

      # PASO CLAVE: Crear la configuraci√≥n en un archivo limpio
      # Esto evita el error de "Failed to start scan" por mala sintaxis
      - name: Configurar Autenticaci√≥n ZAP
        run: |
          TOKEN="${{ github.event.inputs.auth_token }}"
          
          # Escribimos las reglas en un archivo .prop
          cat <<EOF > ./zap/wrk/zap_options.prop
          replacer.full_list(0).description=auth
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).replacement=Token $TOKEN
          EOF
          
          chmod 777 ./zap/wrk/zap_options.prop
          echo "üîê Configuraci√≥n de Auth generada en archivo."

      - name: Run ZAP API Scan
        run: |
          echo "üîç [SCAN] Iniciando escaneo API"
          
          OPENAPI_URL="https://raw.githubusercontent.com/Jneira00001/APIv2_DAST/refs/heads/main/openapi.json"
          API_BASE="https://demo.defectdojo.org"
          REPORT="zap-report-${{ env.TIMESTAMP }}"
          
          echo "üéØ Target: $OPENAPI_URL"

          # Ejecutamos Docker
          # NOTA: Usamos -z "-configfile ..." para leer el archivo creado arriba
          # Usamos zap-stable para mayor estabilidad
          
          docker run --rm -u 0 \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t "$OPENAPI_URL" \
            -f openapi \
            -z "-configfile /zap/wrk/zap_options.prop" \
            -O "$API_BASE" \
            -r "$REPORT.html" \
            -J "$REPORT.json" \
            -l WARN \
            || echo "‚ö†Ô∏è ZAP finaliz√≥ con hallazgos (Exit code no cero es normal en ZAP)"

      - name: Check results
        run: |
          echo "üìã [CHECK] Verificando resultados"
          ls -la ./zap/wrk/
          
          if [ -f "./zap/wrk/zap-report-${{ env.TIMESTAMP }}.html" ]; then
            echo "‚úÖ HTML report generado con √©xito"
          else
            echo "‚ùå ERROR: No se gener√≥ reporte HTML. Revisa la autenticaci√≥n."
            exit 1
          fi

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports-${{ env.TIMESTAMP }}
          path: ./zap/wrk/
          retention-days: 30
