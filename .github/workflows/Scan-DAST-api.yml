name: DAST Scan DefectDojo API - Auto

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      auth_token:
        description: 'Token de autenticaci√≥n'
        required: true
        default: '548afd6fab3bea9794a41b31da0e9404f733e222'

jobs:
  zap_api_scan:
    runs-on: ubuntu-latest
    name: Scan DefectDojo API
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
        
      - name: Verificar OpenAPI
        run: |
          echo "üìä Verificando OpenAPI.json..."
          if [ -f "openapi.json" ]; then
            echo "‚úÖ openapi.json encontrado"
            echo "Tama√±o: $(wc -l < openapi.json) l√≠neas"
          else
            echo "‚ùå ERROR: No se encontr√≥ openapi.json"
            exit 1
          fi
        
      - name: Create ZAP directory
        run: |
          mkdir -p ./zap/wrk
          sudo chmod -R 777 ./zap/wrk
        
      - name: Run ZAP API Scan
        run: |
          echo "üéØ INICIANDO ESCANEO API CON ZAP"
          echo "========================================"
          echo "üìÖ Fecha: ${{ env.TIMESTAMP }}"
          echo "üîó Trigger: ${{ github.event_name }}"
          echo "üìå Commit: ${GITHUB_SHA:0:8}"
          echo "üîê Token: ********${{ github.event.inputs.auth_token: -8 }}"
          echo "üìÑ OpenAPI: openapi.json"
          
          AUTH_TOKEN="${{ github.event.inputs.auth_token }}"
          REPORT_NAME="zap-api-report-${{ env.TIMESTAMP }}"
          
          # Configurar headers de autenticaci√≥n usando -z (como dice la documentaci√≥n)
          ZAP_OPTIONS="-config replacer.full_list\\(0\\).description=auth1"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).enabled=true"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).matchtype=REQ_HEADER"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).matchstr=Authorization"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).regex=false"
          ZAP_OPTIONS="$ZAP_OPTIONS -config replacer.full_list\\(0\\).replacement=Token $AUTH_TOKEN"
          
          # Ejecutar ZAP API Scan (usando zap-api-scan.py, NO zap-baseline.py)
          docker run --rm \
            -v $(pwd):/zap/wrk:rw \
            -v $(pwd)/openapi.json:/zap/openapi.json:ro \
            owasp/zap2docker-weekly zap-api-scan.py \
            -t /zap/openapi.json \
            -f openapi \
            -z "$ZAP_OPTIONS" \
            -r "$REPORT_NAME.html" \
            -w "$REPORT_NAME.md" \
            -x "$REPORT_NAME.xml" \
            -J "$REPORT_NAME.json" \
            -a || echo "‚ö†Ô∏è  ZAP termin√≥ con c√≥digo: $?"
          
          echo "========================================"
          echo "‚úÖ ESCANEO API COMPLETADO"
          
          # Mostrar archivos generados
          echo "üìÑ REPORTES GENERADOS:"
          ls -la zap-api-report-* 2>/dev/null || echo "Buscando reportes..."
          ls -la *.html *.json *.xml *.md 2>/dev/null || true
        
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-reports-${{ env.TIMESTAMP }}
          path: |
            zap-api-report-${{ env.TIMESTAMP }}.*
            openapi.json
          retention-days: 30
          if-no-files-found: warn
        
      - name: Mostrar resumen
        if: always()
        run: |
          echo "üìä RESUMEN DEL ESCANEO"
          echo "========================"
          echo "Workflow: ${{ github.workflow }}"
          echo "Ejecuci√≥n: #${{ github.run_number }}"
          echo "Estado: ${{ job.status }}"
          echo "Commit: ${GITHUB_SHA:0:8}"
          echo "Timestamp: ${{ env.TIMESTAMP }}"
          echo ""
          echo "üìÅ REPORTES DISPONIBLES:"
          echo "  ‚Ä¢ zap-api-report-${{ env.TIMESTAMP }}.html"
          echo "  ‚Ä¢ zap-api-report-${{ env.TIMESTAMP }}.json"
          echo "  ‚Ä¢ zap-api-report-${{ env.TIMESTAMP }}.xml"
          echo "  ‚Ä¢ zap-api-report-${{ env.TIMESTAMP }}.md"
          echo "  ‚Ä¢ openapi.json (original)"
          echo ""
          echo "üìç Descargar desde: Artifacts ‚Üí zap-api-reports-${{ env.TIMESTAMP }}"
          echo "========================"
