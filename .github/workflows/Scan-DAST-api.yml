name: ZAP API Scan (OpenAPI local + Auth + Logs)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  API_TOKEN: "548afd6fab3bea9794a41b31da0e9404f733e222"

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Preparar directorios
        run: |
          mkdir -p zap/wrk zap/zaplog
          chmod -R 777 zap

      # ðŸ”‘ ConfiguraciÃ³n de headers (API Key)
      - name: Crear configuraciÃ³n ZAP (headers)
        run: |
          cat <<EOF > zap/wrk/zap_options.prop
          replacer.full_list(0).description=AuthorizationHeader
          replacer.full_list(0).enabled=true
          replacer.full_list(0).matchtype=REQ_HEADER
          replacer.full_list(0).matchstr=Authorization
          replacer.full_list(0).regex=false
          replacer.full_list(0).replacement=Token ${API_TOKEN}

          replacer.full_list(1).description=AcceptJson
          replacer.full_list(1).enabled=true
          replacer.full_list(1).matchtype=REQ_HEADER
          replacer.full_list(1).matchstr=Accept
          replacer.full_list(1).regex=false
          replacer.full_list(1).replacement=application/json
          EOF

      # ðŸš€ Escaneo ZAP
      - name: Ejecutar ZAP API Scan
        run: |
          echo "ðŸš€ Iniciando ZAP API Scan autenticado"
          
          docker run --rm -u 0 \
            -v $(pwd):/zap/wrk:rw \
            -v $(pwd)/zap/zaplog:/home/zap/.ZAP:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t /zap/wrk/openapi.json \
            -f openapi \
            -r zap_api_report.html \
            -d \
            --max-endpoints 10 \
            -z "
              -configfile /zap/wrk/zap/wrk/zap_options.prop
              -config logger.level=DEBUG
              -config api.disablekey=true
            " \
            2>&1 | tee zap/wrk/zap_console.log

      # ðŸ“¦ Subir artefactos
      - name: Subir reporte y logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-api-results
          path: |
            zap/wrk/zap_api_report.html
            zap/wrk/zap_console.log
            zap/zaplog/zap.log
